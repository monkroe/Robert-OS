// benas-telegram/index.ts
// Telegram webhook -> (Auth + Model Menu) -> (GDELT) -> Gemini (Benas) -> Telegram reply
//
// ENV (Supabase Secrets):
//  - TELEGRAM_BOT_TOKEN
//  - GEMINI_API_KEY
//  - SUPABASE_URL
//  - SUPABASE_SERVICE_ROLE_KEY
//
// IMPORTANT: Turn OFF "JWT Verification" in Supabase Edge Function settings.

import { createClient } from "npm:@supabase/supabase-js@2.94.1";

type TgFrom = { id?: number; username?: string };
type TgChat = { id?: number };

type TgMessage = {
  chat?: TgChat;
    from?: TgFrom;
      text?: string;
      };

      type TgCallbackQuery = {
        id?: string;
          from?: TgFrom;
            message?: { chat?: TgChat; message_id?: number };
              data?: string;
              };

              type TelegramUpdate = {
                message?: TgMessage;
                  edited_message?: TgMessage;
                    callback_query?: TgCallbackQuery;
                    };

                    function nowIso() {
                      return new Date().toISOString();
                      }

                      async function fetchWithTimeout(url: string, options: RequestInit, ms: number) {
                        const controller = new AbortController();
                          const id = setTimeout(() => controller.abort(), ms);
                            try {
                                return await fetch(url, { ...options, signal: controller.signal });
                                  } finally {
                                      clearTimeout(id);
                                        }
                                        }

                                        async function sendTelegramMessage(botToken: string, chatId: number, text: string, extra?: any) {
                                          const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
                                            await fetchWithTimeout(
                                                url,
                                                    {
                                                          method: "POST",
                                                                headers: { "content-type": "application/json" },
                                                                      body: JSON.stringify({
                                                                              chat_id: chatId,
                                                                                      text,
                                                                                              disable_web_page_preview: true,
                                                                                                      ...extra,
                                                                                                            }),
                                                                                                                },
                                                                                                                    12000,
                                                                                                                      );
                                                                                                                      }

                                                                                                                      async function editTelegramMessage(botToken: string, chatId: number, messageId: number, text: string, extra?: any) {
                                                                                                                        const url = `https://api.telegram.org/bot${botToken}/editMessageText`;
                                                                                                                          await fetchWithTimeout(
                                                                                                                              url,
                                                                                                                                  {
                                                                                                                                        method: "POST",
                                                                                                                                              headers: { "content-type": "application/json" },
                                                                                                                                                    body: JSON.stringify({
                                                                                                                                                            chat_id: chatId,
                                                                                                                                                                    message_id: messageId,
                                                                                                                                                                            text,
                                                                                                                                                                                    disable_web_page_preview: true,
                                                                                                                                                                                            ...extra,
                                                                                                                                                                                                  }),
                                                                                                                                                                                                      },
                                                                                                                                                                                                          12000,
                                                                                                                                                                                                            );
                                                                                                                                                                                                            }

                                                                                                                                                                                                            async function answerCallback(botToken: string, callbackQueryId: string, text?: string) {
                                                                                                                                                                                                              const url = `https://api.telegram.org/bot${botToken}/answerCallbackQuery`;
                                                                                                                                                                                                                await fetchWithTimeout(
                                                                                                                                                                                                                    url,
                                                                                                                                                                                                                        {
                                                                                                                                                                                                                              method: "POST",
                                                                                                                                                                                                                                    headers: { "content-type": "application/json" },
                                                                                                                                                                                                                                          body: JSON.stringify({
                                                                                                                                                                                                                                                  callback_query_id: callbackQueryId,
                                                                                                                                                                                                                                                          text: text ?? "",
                                                                                                                                                                                                                                                                  show_alert: false,
                                                                                                                                                                                                                                                                        }),
                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                                8000,
                                                                                                                                                                                                                                                                                  );
                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                  async function sendTyping(botToken: string, chatId: number) {
                                                                                                                                                                                                                                                                                    const url = `https://api.telegram.org/bot${botToken}/sendChatAction`;
                                                                                                                                                                                                                                                                                      await fetchWithTimeout(
                                                                                                                                                                                                                                                                                          url,
                                                                                                                                                                                                                                                                                              {
                                                                                                                                                                                                                                                                                                    method: "POST",
                                                                                                                                                                                                                                                                                                          headers: { "content-type": "application/json" },
                                                                                                                                                                                                                                                                                                                body: JSON.stringify({ chat_id: chatId, action: "typing" }),
                                                                                                                                                                                                                                                                                                                    },
                                                                                                                                                                                                                                                                                                                        4000,
                                                                                                                                                                                                                                                                                                                          );
                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                          function splitTelegram(text: string, chunkSize = 3500) {
                                                                                                                                                                                                                                                                                                                            const chunks: string[] = [];
                                                                                                                                                                                                                                                                                                                              for (let i = 0; i < text.length; i += chunkSize) chunks.push(text.slice(i, i + chunkSize));
                                                                                                                                                                                                                                                                                                                                return chunks;
                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                // -----------------------
                                                                                                                                                                                                                                                                                                                                // Helpers: IDs
                                                                                                                                                                                                                                                                                                                                // -----------------------
                                                                                                                                                                                                                                                                                                                                function getChatId(update: TelegramUpdate): number | null {
                                                                                                                                                                                                                                                                                                                                  const id =
                                                                                                                                                                                                                                                                                                                                      update?.message?.chat?.id ??
                                                                                                                                                                                                                                                                                                                                          update?.edited_message?.chat?.id ??
                                                                                                                                                                                                                                                                                                                                              update?.callback_query?.message?.chat?.id;
                                                                                                                                                                                                                                                                                                                                                return typeof id === "number" ? id : null;
                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                function getFrom(update: TelegramUpdate): TgFrom | null {
                                                                                                                                                                                                                                                                                                                                                  return update?.message?.from ?? update?.edited_message?.from ?? update?.callback_query?.from ?? null;
                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                  function getIncomingText(update: TelegramUpdate): string | null {
                                                                                                                                                                                                                                                                                                                                                    const t = update?.message?.text ?? update?.edited_message?.text;
                                                                                                                                                                                                                                                                                                                                                      if (typeof t === "string" && t.trim().length > 0) return t.trim();
                                                                                                                                                                                                                                                                                                                                                        return null;
                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                        // -----------------------
                                                                                                                                                                                                                                                                                                                                                        // GDELT (Naujienų Radaras)
                                                                                                                                                                                                                                                                                                                                                        // -----------------------
                                                                                                                                                                                                                                                                                                                                                        function buildGdeltQuery(userText: string) {
                                                                                                                                                                                                                                                                                                                                                          const raw = (userText ?? "").trim();
                                                                                                                                                                                                                                                                                                                                                            if (raw.length < 8) {
                                                                                                                                                                                                                                                                                                                                                                return "Federal Reserve OR FOMC OR rates OR inflation OR crypto OR bitcoin OR Kaspa OR stocks OR hack OR regulation";
                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                    if (/\bfed\b|\bfomc\b|\bpowell\b|\bcpi\b|\binflation\b|\brate(s)?\b/i.test(raw))
                                                                                                                                                                                                                                                                                                                                                                        return "Federal Reserve OR FOMC OR Powell OR interest rates OR CPI OR inflation";
                                                                                                                                                                                                                                                                                                                                                                          if (/\bkaspa\b|\bkas\b/i.test(raw)) return "Kaspa OR KASPA OR $KAS";
                                                                                                                                                                                                                                                                                                                                                                            if (/\bbtc\b|\bbitcoin\b/i.test(raw)) return "Bitcoin OR BTC";
                                                                                                                                                                                                                                                                                                                                                                              if (/\bltc\b|\blitecoin\b/i.test(raw)) return "Litecoin OR LTC";
                                                                                                                                                                                                                                                                                                                                                                                if (/\bsol\b|\bsolana\b/i.test(raw)) return "Solana OR SOL";
                                                                                                                                                                                                                                                                                                                                                                                  if (/\bjup\b|\bjupiter\b|\bkamino\b/i.test(raw)) return "Jupiter OR JUP OR Kamino";
                                                                                                                                                                                                                                                                                                                                                                                    if (/\bbybit\b|\bcoinbase\b|\bkraken\b|\bmexc\b/i.test(raw)) return "Bybit OR Coinbase OR Kraken OR MEXC";
                                                                                                                                                                                                                                                                                                                                                                                      if (/\bhack\b|\bexploit\b|\bbreach\b|\bdrain\b/i.test(raw)) return "crypto hack OR exploit OR drained OR breach";
                                                                                                                                                                                                                                                                                                                                                                                        if (/\bnvda\b|\bnvidia\b/i.test(raw)) return "NVIDIA OR NVDA";
                                                                                                                                                                                                                                                                                                                                                                                          if (/\bmstr\b|\bmicrostrategy\b/i.test(raw)) return "MicroStrategy OR MSTR";
                                                                                                                                                                                                                                                                                                                                                                                            if (/\btsla\b|\btesla\b/i.test(raw)) return "Tesla OR TSLA";

                                                                                                                                                                                                                                                                                                                                                                                              return `${raw} OR crypto OR stocks OR macro`;
                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                              async function getGdeltNewsSnapshot(userText: string) {
                                                                                                                                                                                                                                                                                                                                                                                                const query = buildGdeltQuery(userText);

                                                                                                                                                                                                                                                                                                                                                                                                  const params = new URLSearchParams({
                                                                                                                                                                                                                                                                                                                                                                                                      query,
                                                                                                                                                                                                                                                                                                                                                                                                          mode: "ArtList",
                                                                                                                                                                                                                                                                                                                                                                                                              format: "json",
                                                                                                                                                                                                                                                                                                                                                                                                                  maxrecords: "10",
                                                                                                                                                                                                                                                                                                                                                                                                                      sort: "HybridRel",
                                                                                                                                                                                                                                                                                                                                                                                                                        });

                                                                                                                                                                                                                                                                                                                                                                                                                          const url = `https://api.gdeltproject.org/api/v2/doc/doc?${params.toString()}`;

                                                                                                                                                                                                                                                                                                                                                                                                                            try {
                                                                                                                                                                                                                                                                                                                                                                                                                                const res = await fetchWithTimeout(url, { method: "GET" }, 10000);
                                                                                                                                                                                                                                                                                                                                                                                                                                    if (!res.ok) {
                                                                                                                                                                                                                                                                                                                                                                                                                                          return `NEWS RADAR (GDELT): nepavyko gauti (HTTP ${res.status}). asOf: ${nowIso()}\nQuery: ${query}`;
                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                  const data = await res.json();
                                                                                                                                                                                                                                                                                                                                                                                                                                                      const arts: any[] = data?.articles ?? [];
                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (!Array.isArray(arts) || arts.length === 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                return `NEWS RADAR (GDELT): nerasta. asOf: ${nowIso()}\nQuery: ${query}`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const lines = arts.slice(0, 10).map((a, i) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const title = String(a?.title ?? "(be pavadinimo)").replace(/\s+/g, " ").trim();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const domain = String(a?.domain ?? "unknown").trim();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return `${i + 1}) ${title} [${domain}]`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        `NEWS RADAR (GDELT — triukšmas; rimtas naujienas REIKIA patvirtinti)`,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              `asOf: ${nowIso()}`,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    `Query: ${query}`,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          lines.join("\n"),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ].join("\n");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                } catch (e) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const msg = e instanceof Error ? e.message : String(e);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return `NEWS RADAR (GDELT): ryšio klaida. asOf: ${nowIso()}\nQuery: ${query}\nerr: ${msg}`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // -----------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // Supabase helpers (Auth & Session)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // -----------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          function getSupabaseServiceClient() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const url = Deno.env.get("SUPABASE_URL") ?? "";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const key = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ?? "";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (!url || !key) throw new Error("Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return createClient(url, key, { auth: { persistSession: false } });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  async function getLinkedUserIdByChatId(supabase: any, tg_chat_id: number): Promise<string | null> {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const { data, error } = await supabase
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        .from("bf_user_identities")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            .select("user_id")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                .eq("provider", "telegram")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    .eq("tg_chat_id", tg_chat_id)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        .maybeSingle();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              console.log("getLinkedUserIdByChatId error:", error?.message ?? error);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return null;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      return data?.user_id ?? null;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      async function upsertBotSessionModel(supabase: any, user_id: string, model: "pro" | "flash" | "auto") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const { data: existing } = await supabase
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            .from("bf_bot_sessions")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                .select("temp_data")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    .eq("user_id", user_id)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        .maybeSingle();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const prev = (existing?.temp_data ?? {}) as Record<string, any>;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const next = { ...prev, model };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const { error } = await supabase
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  .from("bf_bot_sessions")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      .upsert({ user_id, step: null, temp_data: next, updated_at: nowIso() });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (error) console.log("upsertBotSessionModel error:", error?.message ?? error);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        async function getBotSessionModel(supabase: any, user_id: string): Promise<"pro" | "flash" | "auto"> {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const { data, error } = await supabase
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              .from("bf_bot_sessions")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  .select("temp_data")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      .eq("user_id", user_id)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          .maybeSingle();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                console.log("getBotSessionModel error:", error?.message ?? error);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return "auto";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const m = data?.temp_data?.model;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (m === "pro" || m === "flash" || m === "auto") return m;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return "auto";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            async function redeemLinkCode(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              supabase: any,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                code: string,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  tg_user_id: number,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tg_chat_id: number,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      tg_username?: string | null,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ): Promise<string> {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const { data, error } = await supabase.rpc("bf_redeem_bot_link_code", {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            p_code: code,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                p_tg_user_id: tg_user_id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    p_tg_chat_id: tg_chat_id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        p_tg_username: tg_username ?? null,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (error) throw new Error(`Pairing failed: ${error.message}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return String(data);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // -----------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // Gemini Logika
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // -----------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              async function geminiGenerate(apiKey: string, modelName: string, systemPrompt: string, inputText: string) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const url = `https://generativelanguage.googleapis.com/v1beta/${modelName}:generateContent?key=${encodeURIComponent(apiKey)}`;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const payload = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      contents: [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    role: "user",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            parts: [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  text:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                `SYSTEM (PRIVALOMA LAIKYTIS):\n${systemPrompt}\n\n` +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              `INPUT (CONTEXT + USER):\n${inputText}\n\n` +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            `OPERATION RULES:\n` +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          `- Atsakyk lietuviškai.\n` +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        `- Kainų/APY/liquidation NIEKADA nekurk iš atminties. Jei jų nėra — prašyk SNAPSHOT.\n` +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      `- Naujienos yra tik fonas (sentiment). Pirmiausia — Roberto skaičiai ir tikslai.\n`,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      generationConfig: {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            temperature: 0.35,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  maxOutputTokens: 1800,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const res = await fetchWithTimeout(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              url,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  { method: "POST", headers: { "content-type": "application/json" }, body: JSON.stringify(payload) },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      30000,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        );

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const rawText = await res.text().catch(() => "");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (!res.ok) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const err = new Error(`Gemini error ${res.status}: ${rawText.slice(0, 900)}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    (err as any).status = res.status;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        throw err;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            let data: any;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  data = JSON.parse(rawText);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } catch {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return `Benas: Gemini grąžino ne JSON.\n${rawText.slice(0, 500)}`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const parts = data?.candidates?.[0]?.content?.parts;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const text =
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  Array.isArray(parts)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ? parts.map((p: any) => (typeof p?.text === "string" ? p.text : "")).join("")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              : "";

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (text && text.length > 0) return text;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const finish = data?.candidates?.[0]?.finishReason ?? "unknown";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const block = data?.promptFeedback?.blockReason ?? "none";

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // Minimalus server-side log (kad matytum kas vyksta)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        console.log("Gemini empty response meta:", { finish, block, promptFeedback: data?.promptFeedback });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return `Benas: Gemini grąžino tuščią atsakymą.\nfinishReason: ${finish}\nblockReason: ${block}`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          async function callGeminiByMode(apiKey: string, mode: "pro" | "flash" | "auto", systemPrompt: string, inputText: string) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const pro = "models/gemini-2.5-pro";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const flash = "models/gemini-2.5-flash";

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (mode === "pro") return await geminiGenerate(apiKey, pro, systemPrompt, inputText);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (mode === "flash") return await geminiGenerate(apiKey, flash, systemPrompt, inputText);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return await geminiGenerate(apiKey, pro, systemPrompt, inputText);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          } catch (e) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const status = (e as any)?.status;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (status === 429 || status === 503 || status === 504 || status === 404) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const t = await geminiGenerate(apiKey, flash, systemPrompt, inputText);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return t + "\n\n(⚡ AUTO perjungė į FLASH)";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      throw e;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // -----------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // BENO SIELA (Platinum) — palikta
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // -----------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const BENAS_SYSTEM = `
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # SYSTEM — BENAS (Roberto Finansinis Strategas)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        TU ESI: Benas. Roberto finansinis strategas + bendražygis (draugas ir motyvatorius).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        TONAS: tiesus, be bullshit. Humoras OK, bet pinigai rimta. Robertas nėra naujokas.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ROBERTO PROFILIS:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - **Tikslas:** Finansinė Laisvė + "Sąnašų" sodyba (Lietuva).
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - **Lokacija:** Chicago area, USA.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - **Portfelis:** KASPA ($KAS) - High Conviction. BTC, LTC, SOL, CRO, JUP.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - **Stocks:** NVDA, MSTR, TSLA.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - **Darbas:** Logistika/Rideshare (sunkiai uždirbami pinigai).

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        KRITINĖ TAISYKLĖ: ZERO GUESSING
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - Kainų / APY / funding / TVL / procentų NIEKADA nesakai iš atminties.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - Jei neturi real-time skaičių: aiškiai pasakyk “neturiu realaus laiko duomenų šiame režime” ir paprašyk SNAPSHOT.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        NEWS RADAR (GDELT)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - GDELT yra RADARAS (triukšmas). Rimtas naujienas pažymėk “REIKIA PATVIRTINTI”.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - Iš antraščių nedaryk kategoriškų išvadų. Jei trūksta faktų — pateik 2–3 HIPOTEZES ir aiškiai pažymėk “HIPOTEZĖ”.

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ATSAKYMO STRUKTŪRA (visada)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        1) Faktai (ką turiu iš INPUT; jei trūksta — ko)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        2) Rizika (liquidation buffer, drawdown, koncentracija, counterparty)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        3) 2–3 keliai (konservatyvus / bazinis / agresyvus) + pasekmės
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        4) Mano take (short-term vs long-term)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        5) Ką darom dabar (1–3 konkretūs veiksmai)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        DRAUGO/MOTYVATORIAUS REŽIMAS
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - Panika: “Stop. Įkvėpk. Duok snapshot. Sprendžiam šaltu protu.”
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - Euforija: “Pelno neužtenka pamatyti — jį reikia apsaugoti.”
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - Klaida: “Klaida jau įvyko. Klausimas: ką darom dabar. Judam.”
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        `.trim();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // -----------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // UI: model menu (Keyboard)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // -----------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        function modelMenuKeyboard(current: "pro" | "flash" | "auto") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const mark = (m: string) => (m === current ? "✅" : "");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                inline_keyboard: [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              { text: `${mark("pro")} PRO`, callback_data: "model:pro" },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      { text: `${mark("auto")} AUTO`, callback_data: "model:auto" },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              { text: `${mark("flash")} FLASH`, callback_data: "model:flash" },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          Deno.serve(async (req) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (req.method === "GET") return new Response("Benas Online & Ready 🐺");

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const botToken = Deno.env.get("TELEGRAM_BOT_TOKEN") ?? "";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const geminiKey = Deno.env.get("GEMINI_API_KEY") ?? "";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (!botToken || !geminiKey) return new Response("Missing TELEGRAM_BOT_TOKEN or GEMINI_API_KEY", { status: 500 });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    let update: TelegramUpdate;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          update = await req.json();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            } catch {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return new Response("Bad JSON", { status: 400 });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const chatId = getChatId(update);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (!chatId) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          return new Response(JSON.stringify({ ok: true }), { headers: { "content-type": "application/json" } });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const from = getFrom(update);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const tg_user_id = from?.id ?? null;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const tg_username = from?.username ?? null;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const supabase = getSupabaseServiceClient();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // -----------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // CALLBACK: model selection
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  // -----------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (update.callback_query?.data && update.callback_query?.id) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const cb = update.callback_query;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const data = cb.data;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const messageId = cb.message?.message_id;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const linkedUserId = await getLinkedUserIdByChatId(supabase, chatId);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (!linkedUserId) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            await answerCallback(botToken, cb.id, "Pirma susiporuok: įvesk pairing kodą.");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (messageId) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              await editTelegramMessage(botToken, chatId, messageId, "❌ Neporintas. Įvesk pairing kodą (10 simbolių) ir kartok /model.");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return new Response(JSON.stringify({ ok: true }), { headers: { "content-type": "application/json" } });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (data.startsWith("model:")) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const mode = data.split(":")[1] as any;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (mode === "pro" || mode === "flash" || mode === "auto") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await upsertBotSessionModel(supabase, linkedUserId, mode);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              await answerCallback(botToken, cb.id, `OK: ${mode.toUpperCase()}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (messageId) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await editTelegramMessage(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  botToken,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                chatId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              messageId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            `✅ Modelis nustatytas: ${mode.toUpperCase()}\n\nRašyk žinutę toliau.`,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          { reply_markup: modelMenuKeyboard(mode) },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  await answerCallback(botToken, cb.id, "Nežinomas pasirinkimas.");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        await answerCallback(botToken, cb.id, "OK");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return new Response(JSON.stringify({ ok: true }), { headers: { "content-type": "application/json" } });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // -----------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // MESSAGE FLOW
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // -----------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const text = getIncomingText(update);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (!text) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return new Response(JSON.stringify({ ok: true }), { headers: { "content-type": "application/json" } });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // /start
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (text === "/start") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await sendTelegramMessage(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            botToken,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    chatId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Benas online 🐺\n\n1) Jei dar nesuporuota: įvesk pairing kodą (10 simbolių).\n2) Modelio meniu: /model\n3) Diagnostika: /id",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return new Response(JSON.stringify({ ok: true }), { headers: { "content-type": "application/json" } });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // /id (diagnostika telefone)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (text === "/id") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          await sendTelegramMessage(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  botToken,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          chatId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  `ID:\nchat_id: ${chatId}\nfrom_id: ${tg_user_id ?? "null"}\nusername: ${tg_username ?? "null"}`,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return new Response(JSON.stringify({ ok: true }), { headers: { "content-type": "application/json" } });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // lookup link
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          let userId = await getLinkedUserIdByChatId(supabase, chatId);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              // Pairing code
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const looksLikeCode = /^[A-F0-9]{8,12}$/i.test(text.replace(/\s+/g, ""));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      if (!userId && looksLikeCode) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (!tg_user_id) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    await sendTelegramMessage(botToken, chatId, "❌ Negaliu paimti tg_user_id (from.id). Parašyk /id ir atsiųsk ką rodo.");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return new Response(JSON.stringify({ ok: true }), { headers: { "content-type": "application/json" } });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const code = text.replace(/\s+/g, "").toUpperCase();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              await sendTyping(botToken, chatId);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const linked = await redeemLinkCode(supabase, code, tg_user_id, chatId, tg_username);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          userId = linked;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                await upsertBotSessionModel(supabase, userId, "auto");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      await sendTelegramMessage(botToken, chatId, "✅ Suporuota. Dabar /model ir pasirink PRO/AUTO/FLASH.");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return new Response(JSON.stringify({ ok: true }), { headers: { "content-type": "application/json" } });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // /model menu
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (text === "/model") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (!userId) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      await sendTelegramMessage(botToken, chatId, "❌ Neporintas. Įvesk pairing kodą (10 simbolių).");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              return new Response(JSON.stringify({ ok: true }), { headers: { "content-type": "application/json" } });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const current = await getBotSessionModel(supabase, userId);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                await sendTelegramMessage(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        botToken,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                chatId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        `Pasirink modelį:\n- PRO (galingas)\n- FLASH (pigiau/greičiau)\n- AUTO (pro → flash jei lūžta)`,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                { reply_markup: modelMenuKeyboard(current) },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return new Response(JSON.stringify({ ok: true }), { headers: { "content-type": "application/json" } });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // still not linked
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (!userId) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              await sendTelegramMessage(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      botToken,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              chatId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      "❌ Neporintas. Įvesk pairing kodą (10 simbolių) iš UI (bf_create_bot_link_code).",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  return new Response(JSON.stringify({ ok: true }), { headers: { "content-type": "application/json" } });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          // MAIN: Benas
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              await sendTyping(botToken, chatId);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const mode = await getBotSessionModel(supabase, userId);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const news = await getGdeltNewsSnapshot(text);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const input =
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                `CONTEXT (NEWS RADAR):\n${news}\n\n` +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      `USER MESSAGE:\n${text}\n\n` +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            `NOTE: Jei reikia tikslių kainų/APY/liquidation — paprašyk SNAPSHOT.\n`;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const answer = await callGeminiByMode(geminiKey, mode, BENAS_SYSTEM, input);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const out = answer && answer.length ? answer : "Benas: techninė bėda (tuščias atsakymas).";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const chunks = splitTelegram(out, 3500);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for (let i = 0; i < Math.min(chunks.length, 5); i++) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  await sendTelegramMessage(botToken, chatId, chunks[i]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } catch (e) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const msg = e instanceof Error ? e.message : String(e);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                await sendTelegramMessage(botToken, chatId, `Benas: techninė bėda.\n${msg}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return new Response(JSON.stringify({ ok: true }), { headers: { "content-type": "application/json" } });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    });